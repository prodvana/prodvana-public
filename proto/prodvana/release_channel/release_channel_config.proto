syntax = "proto3";
package prodvana.release_channel;
option go_package = "github.com/prodvana/prodvana-public/go/prodvana-sdk/proto/prodvana/release_channel";

import "prodvana/common_config/constants.proto";
import "prodvana/common_config/env.proto";
import "prodvana/common_config/maturity.proto";
import "prodvana/labels/labels.proto";
import "prodvana/pipelines/pipelines.proto";
import "prodvana/protection/attachments.proto";
import "prodvana/runtimes/runtimes_config.proto";
import "prodvana/workflow/integration_config.proto";
import "validate/validate.proto";

message Policy {
    map<string, prodvana.common_config.EnvValue> default_env = 1 [(validate.rules).map = {
        keys: {
            string: {
                pattern: '^[a-zA-Z_]+[a-zA-Z0-9_]*$',
            },
        },
        no_sparse: true,
    }];
}

message ReleaseChannelConfig {
    // intentionally does not reference cluster - this allows us to copy release channels across clusters via the same config
    string name = 1 [
        (validate.rules).string = {
            min_len: 1,
            max_len: 63,
            pattern: '^[a-z]([a-z0-9-]*[a-z0-9]){0,1}$',
        }
    ];
    // if specified, this release channel is part of a group. This can affect how release channels are rendered on the Prodvana web interface.
    string group = 12;
    int64 order = 2; // deprecated
    prodvana.common_config.Maturity maturity = 3;  // deprecated
    Policy policy = 4;

    repeated ReleaseChannelRuntimeConfig runtimes = 5;
    prodvana.workflow.AnnotationsConfig deploy_annotations = 6;

    repeated Precondition preconditions = 7;

    repeated prodvana.protection.ProtectionAttachmentConfig protections = 8;
    repeated prodvana.protection.ProtectionAttachmentConfig convergence_protections = 9;
    // protections that all service instances in this release channel should get
    repeated prodvana.protection.ProtectionAttachmentConfig service_instance_protections = 11;

    // constants made available in template substitutions
    repeated prodvana.common_config.Constant constants = 10;
    repeated prodvana.labels.LabelDefinition labels = 13;

    // Disable all protections for this release channel - protections will not be created for any service instances in this release channel.
    // This is useful for release channels that are used for testing or are not yet in production (e.g., fast creation of new tenants).
    bool disable_all_protections = 14;

    // next tag: 14
}

message Precondition {
    message ReleaseChannelStable {
        oneof stable_oneof {
            option (validate.required) = true;
            string release_channel = 1;
            string selector = 3;
        }
        // if selector is used, allow selector to return an empty list of release channels
        bool allow_empty = 4;
        reserved 2;
        reserved "duration";
    }
    message ManualApproval {
        string name = 1;
        string description = 2;
        // request approval on every apply action, not just the first.
        // only works for runtime extensions, will do nothing for kubernetes services.
        bool every_action = 3;
        // if set, a unique number of users must approve this precondition before the release channel can be deployed.
        int32 min_approvers = 4;
    }
    message CustomTask {
        string task_name = 1;
        prodvana.pipelines.CustomTask custom_task = 2;
        // if set, a unique number of users must approve this precondition before the release channel can be deployed.
        int32 min_approvers = 3 [(validate.rules).int32.gte = 0];
    }
    message SharedManualApproval {
        string name = 1 [(validate.rules).string.min_len = 1];
        int32 min_approvers = 2 [(validate.rules).int32.gte = 0];
    }
    oneof precondition {
        ReleaseChannelStable release_channel_stable = 1;
        ManualApproval manual_approval = 2;
        CustomTask custom_task = 3;
        SharedManualApproval shared_manual_approval = 5;
    }
    reserved 4;
    reserved "protection";
}

enum RuntimeConnectionType {
    UNKNOWN_CONNECTION = 0;
    LONG_LIVED_COMPUTE = 1;
    EXTENSION = 2;
    AWS_ECS = 3;
    GOOGLE_CLOUD_RUN = 4;
}

message ReleaseChannelRuntimeConfig {
    string runtime = 2 [
        (validate.rules).string = {
            min_len: 1,
            max_len: 63,
            pattern: '^[a-z]([a-z0-9-]*[a-z0-9]){0,1}$',
        }
    ];
    // Optional identifier for this runtime connection within this release channel,
    // useful if the release channel has multiple runtimes of the same type.
    // Defaults to the value of `runtime``.
    string name = 3 [
        (validate.rules).string = {
            min_len: 0,
            max_len: 63,
            pattern: '^[a-z]?([a-z0-9-]*[a-z0-9]){0,1}$',
        }
    ];
    oneof capability {  // if not set, will be autogenerated to container orchestration
        prodvana.runtimes.ContainerOrchestrationRuntime container_orchestration = 1;
    }

    // set internally by prodvana, overridden even if set manually.
    RuntimeConnectionType type = 4;

    // next tag: 5
}

message ReleaseChannelGroupGeneratorConfig {
    string name = 1 [
        (validate.rules).string = {
            min_len: 1,
            max_len: 63,
            pattern: '^[a-z]([a-z0-9-]*[a-z0-9]){0,1}$',
        }
    ];
    // label selector for runtimes to generate release channels for.
    // One release channel will be generated for each runtime that matches this selector.
    // The selector will automatically be intersected with "@type=runtime".
    string runtime_selector = 2 [(validate.rules).string.min_len = 1];

    // By default, if the runtime selector returns an empty list of runtimes, Prodvana will error out.
    // Set allow_empty to true to explicitly allow the selector to return an empty list.
    bool allow_empty = 3;

    // optionally customize how the release channel will be generated.
    // Template variables .Builtins.Group an d.Builtins.Runtime are available.
    // Any value specified here will be merged with:
    // name: {{.Builtins.Group}}-{{.Builtins.Runtime.Name}}
    // group: {{.Builtins.Group}}
    // runtimes:
    // - runtime: {{Builtins.Runtime.Name}}
    ReleaseChannelConfig template = 4 [(validate.rules).message.skip = true];
}
